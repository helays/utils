## 问题分析

如果窗口时间比锁定时间短：
- IP锁定30分钟，窗口时间10分钟
- IP在00:00锁定，00:30解锁
- 记忆窗口在00:10就结束了，但IP还在锁定中
- 00:30解锁时已经不在记忆窗口内，记忆效应失效

## 修正配置

```go
policies := lockpolicy.Policies{
    // Session -> IP 升级，带记忆效应
    {
        Target:      lockpolicy.LockTargetSession,
        Trigger:     3,
        WindowTime:  1 * time.Minute,     // Session统计窗口
        LockoutTime: 5 * time.Minute,     // Session锁定5分钟
        Escalation: &lockpolicy.EscalationRule{
            LockoutCount: 5,
            TimeWindow:   30 * time.Minute, // Session锁定次数统计窗口
            UpgradeTo:    lockpolicy.LockTargetIP,
            UpgradeTime:  30 * time.Minute, // IP升级锁定30分钟
            MemoryEffect: true,
        },
    },
    
    // IP 层策略
    {
        Target:      lockpolicy.LockTargetIP,
        Trigger:     5,
        WindowTime:  60 * time.Minute,    // IP窗口60分钟 > IP锁定30分钟
        LockoutTime: 30 * time.Minute,    // IP锁定30分钟
        Escalation: &lockpolicy.EscalationRule{
            LockoutCount: 3,
            TimeWindow:   2 * time.Hour,   // IP锁定次数统计窗口
            UpgradeTo:    lockpolicy.LockTargetUser,
            UpgradeTime:  24 * time.Hour,  // User锁定24小时
        },
    },
    
    // User 层策略  
    {
        Target:      lockpolicy.LockTargetUser,
        Trigger:     0,
        WindowTime:  0,
        LockoutTime: 24 * time.Hour,
    },
}
```

## 时间关系说明

### Session层：
- **失败统计窗口**：1分钟（短窗口快速响应）
- **锁定时间**：5分钟
- **升级统计窗口**：30分钟（累计5次锁定）

### IP层：
- **失败统计窗口**：60分钟（记忆窗口）
- **锁定时间**：30分钟
- **升级统计窗口**：2小时（累计3次锁定）

**关键**：IP的窗口时间(60分钟) > IP的锁定时间(30分钟)，确保解锁时仍在记忆窗口内。

## 完整攻击时间线（修正版）

```
时间线（攻击开始于 00:00）：
00:00 - 攻击开始
00:01 - 会话失败3次 → 会话锁定5分钟
    🔒 Session锁定至 00:06

... (重复攻击模式) ...

00:21 - 第五次会话锁定
    ⚡ 触发升级：锁定IP 30分钟
    🔒 IP锁定至 00:51
    🧠 启用记忆效应，记忆窗口至 01:51（60分钟）

00:51 - IP解锁，此时仍在记忆窗口内（00:51在01:51之前）
00:52 - 攻击者再次尝试
    🔄 记忆效应生效：直接记录IP层失败
    📊 IP失败计数: 1/5 (窗口: 00:52-01:52)

00:53 - 再次失败
    📊 IP失败计数: 2/5

... (继续累积)...

01:00 - IP失败达到5次
    🔒 IP重新锁定30分钟
    🔒 IP锁定至 01:30
    🧠 记忆窗口重置至 02:30（从解锁开始计算）

01:30 - IP再次解锁，仍在记忆窗口内（01:30在02:30之前）
01:31 - 继续攻击，记录IP失败
    📊 IP失败计数: 1/5 (新窗口: 01:31-02:31)

... 如此循环，直到触发User锁定 ...
```

## 窗口时间设计原则

1. **失败统计窗口** ≥ **锁定时间**（确保记忆效应有效）
2. **低层级窗口短**：Session层快速响应
3. **高层级窗口长**：IP/User层持久防护
4. **升级统计窗口** > **失败统计窗口**：给升级留出足够时间

## 建议的时间比例

```go
// 推荐的时间比例关系
Session: {
    WindowTime:   1 * time.Minute,    // 短窗口快速响应
    LockoutTime:  5 * time.Minute,    // 短时间锁定
}

IP: {
    WindowTime:   60 * time.Minute,   // 长窗口持久记忆  
    LockoutTime:  30 * time.Minute,   // 中等时间锁定
}

User: {
    WindowTime:   24 * time.Hour,     // 很长窗口
    LockoutTime:  24 * time.Hour,     // 长时间锁定
}
```

这样设计确保了记忆效应的有效性，同时各层级的防护时间比例合理。